var isModify=!1;function doDelete(){jobAction("delete")}function changeSchedView(a){$("div[id^=sec_]").hide(),""!==a&&(-1!=a.indexOf("sysCheck")?$("#sec_sysCheck").show():$("#sec_"+a).show())}function jobAction(a){var e=$("input[name=chkbox]:checked");if(isModify&&1!=e.length)return alert("修改僅允許勾選一項，請重新選擇"),void uncheckAll();for(var t=new Array,i=new Object,n=0;n<e.length;n++)(i=new Object).keyVal=e[n].value,t.push(i);$.ajax({url:_ctx+"/admin/job/"+a,data:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,success:function(e){"200"==e.code?"modify"==a?($("#inputJobName").val(e.data.inputJobName),$("#inputJobGroup").val(e.data.inputJobGroup),$("#jobKeyName").val(e.data.inputJobName),$("#jobKeyGroup").val(e.data.inputJobGroup),$("#inputCronExpression").val(e.data.inputCronExpression),$("#inputGroupIds").val(e.data.inputGroupIds),$("#inputDeviceIds").val(e.data.inputDeviceIds),$("#inputPriority").val(e.data.inputPriority),$("#inputDescription").val(e.data.inputDescription),$("#inputFtpName").val(e.data.inputFtpName),$("#inputFtpHost").val(e.data.inputFtpHost),$("#inputFtpPort").val(e.data.inputFtpPort),$("#inputFtpAccount").val(e.data.inputFtpAccount),$("#inputFtpPassword").val(e.data.inputFtpPassword),$("#inputSysCheckSql").val(e.data.inputSysCheckSql),$("#inputDataPollerSettingId").val(e.data.inputDataPollerSettingId),$("#inputLocalFileOperationSettingId").val(e.data.inputLocalFileOperationSettingId),$("#inputMisFirePolicy option").filter(function(){return $(this).val()==e.data.inputMisFirePolicy}).prop("selected",!0),$("#inputSchedType option").filter(function(){return $(this).val()==e.data.inputSchedType}).prop("selected",!0),$("#inputConfigType option").filter(function(){return $(this).val()==e.data.inputConfigType}).prop("selected",!0),$("#inputSchedType").attr("disabled","disabled"),$("#inputJobName").attr("disabled","disabled"),$("#inputJobGroup").attr("disabled","disabled"),$("#sec_"+e.data.inputSchedType).show(),$("#addModifyModal").modal({backdrop:"static"})):(alert(e.message),findData("WEB")):alert(e.message),"403"==e.code&&uncheckAll()},error:function(a,e,t){ajaxErrorHandler()}})}function saveJob(a){var e=$("#formEdit").find(":input:disabled").removeAttr("disabled"),t=JSON.stringify($("#formEdit").serializeObject());e.attr("disabled","disabled"),$.ajax({url:_ctx+"/admin/job/save",data:t,contentType:"application/json; charset=utf-8",type:"POST",dataType:"json",async:!0,success:function(a){"200"==a.code?(alert(a.message),findData("WEB"),setTimeout(function(){$("#addModifyModal").modal("hide")},500)):alert(a.message)},error:function(a,e,t){ajaxErrorHandler()}})}function viewDetail(a){$.ajax({url:_ctx+"/admin/job/getJobDetails.json",data:{jobKeyName:a.split("@~")[0],jobKeyGroup:a.split("@~")[1]},type:"POST",dataType:"json",async:!0,success:function(a){if("200"==a.code){$("#jobDetailsModal").modal(),$("#viewDetailSchedTypeName").val(a.data.schedTypeName),$("#viewDetailConfigType").val(a.data.configType),$("#viewDetailGroupIds").val(a.data.groupId),$("#viewDetailDeviceIds").val(a.data.deviceId),$("#viewDetailFtpName").val(a.data.ftpName),$("#viewDetailFtpHost").val(a.data.ftpHost),$("#viewDetailFtpPort").val(a.data.ftpPort),$("#viewDetailFtpAccount").val(a.data.ftpAccount),$("#viewDetailFtpPassword").val(a.data.ftpPassword),$("#viewDetailSysCheckSql").val(a.data.sysCheckSqls),$("#viewDataPollerSettingId").val(a.data.dataPollerSettingId),$("#viewLocalFileOperationSettingId").val(a.data.localFileOperationSettingId);var e=a.data.schedType;$("div[id^=sec_detail_]").hide(),""!==e&&(-1!=e.indexOf("sysCheck")?$("#sec_detail_sysCheck").show():$("#sec_detail_"+e).show(),$("#sec_detail_common").show())}else alert(a.message)},error:function(a,e,t){ajaxErrorHandler()}})}function findData(a){$("#queryFrom").val(a),$("input[name=checkAll]").prop("checked",!1),"MOBILE"==a&&$("#collapseExample").collapse("hide"),"undefined"!=typeof resutTable?resutTable.ajax.reload():($(".myTableSection").show(),resutTable=$("#resutTable").DataTable({autoWidth:!0,paging:!0,bFilter:!0,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},ajax:{url:_ctx+"/admin/job/getJobInfo.json",type:"POST",data:function(a){},error:function(a,e,t){ajaxErrorHandler()}},order:[[7,"desc"]],drawCallback:function(a){$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust(),$("div.dataTables_length").parent().removeClass("col-sm-12"),$("div.dataTables_length").parent().addClass("col-sm-6"),$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),$("div.dataTables_paginate").parent().removeClass("col-sm-12"),$("div.dataTables_paginate").parent().addClass("col-sm-6"),bindTrEvent(),feather.replace()},columns:[{},{},{},{data:"jobGroup"},{data:"jobName"},{data:"priority"},{data:"triggerState"},{data:"_preFireTime"},{data:"_nextFireTime"},{data:"misfireInstr"},{data:"cronExpression"},{data:"timeZoneId"},{data:"jobClassName"},{},{data:"description"}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(a,e,t){return'<input type="checkbox" id="chkbox" name="chkbox" onclick="changeTrBgColor(this)" value="'+t.jobName+"@~"+t.jobGroup+'">'}},{targets:[1],className:"center",searchable:!1,orderable:!1,render:function(a,e,t,i){return i.row+i.settings._iDisplayStart+1}},{targets:[2],className:"left",searchable:!1,orderable:!1,render:function(a,e,t,i){return t.schedTypeName}},{targets:[13],className:"center",searchable:!1,orderable:!1,render:function(a,e,t){return'<a href="#" onclick="viewDetail(\''+t.jobName+"@~"+t.jobGroup+'\')"><span data-feather="zoom-in"></span></a>'}}]}))}$(document).ready(function(){initMenuStatus("toggleMenu_admin","toggleMenu_admin_items","bk_job"),$("#btnAdd").click(function(){isModify=!1,uncheckAll(),initModal(),$("#addModifyModal").modal({backdrop:"static"})}),$("#btnPause").click(function(){isModify=!1,jobAction("pause")}),$("#btnResume").click(function(){isModify=!1,jobAction("resume")}),$("#btnDelete").click(function(){confirm("確認是否刪除?","doDelete")}),$("#btnModify").click(function(){isModify=!0,changeSchedView($("#inputSchedType").val()),jobAction("modify")}),$("#btnSave").click(function(){saveJob(isModify)}),$("#btnExcute").click(function(){jobAction("excute")}),$("#inputSchedType").change(function(){changeSchedView($(this).val())})});