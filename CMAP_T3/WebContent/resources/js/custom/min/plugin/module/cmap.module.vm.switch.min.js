var switchResult,_ctx=$("meta[name='ctx']").attr("content"),source=null;function hideProcessing2(){$(".mask").hide(),$(".processing2").hide()}function showProcessing2(){$(".mask").show(),$(".processing2").show()}function checkVmStatus(){var e=new Object;$.ajax({url:_ctx+"/plugin/module/vmswitch/chkStatus",data:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,beforeSend:function(e){showProcessing()},complete:function(){hideProcessing()},success:function(e){$("#vmStatusMsg").text(e.data.VM_STATUS_MSG),$("#checkBtn").hide(),$("#goMsg").show(),$("#goBtn").show()},error:function(e,o,s){ajaxErrorHandler()}})}function startSSE(){window.EventSource?(source=new EventSource("vmswitch/push"),s="",$("#msg_from_server").show(),$("#msg_from_server").scrollTop=$("#msg_from_server").scrollHeight,source.addEventListener("message",function(e){var o=JSON.parse(e.data),s=o.time,t=o.step,n=o.result,r=o.msg;if("<CLOSE>"==t)source.close();else if("<NONE>"!=t){if("<PROCESS_END>"==t)r="======================== [ End ] ========================<br><br>",source.close(),$(".processing2").css("background","none"),$("#btnClose").show(),alert(switchResult);else if("<STEP_RESULT>"==t)switch(n){case"<ERROR>":r=' >> <span style="color: #ff4747; vertical-align: top;"><b>'+r+"</b></span><br>";break;case"<OK>":r=' >> <span style="color: #01ff01; vertical-align: top;"><b>'+r+"</b></span><br>";break;case"<WAITING>":r=' >> <span style="color: #ff01ca; vertical-align: top;"><b>'+r+"</b></span><br>";break;default:r=" >> "+r+"<br>"}else r="["+s+"] "+t+' >> <span style="color: yellow; vertical-align: top;">'+r+"</span>";$("#msg_from_server").html(function(e,o){return o+r}),$("#msg_from_server").animate({scrollTop:$("#msg_from_server").prop("scrollHeight")},1e3)}}),source.addEventListener("open",function(e){console.log("連線開啟")},!1),source.addEventListener("error",function(e){e.readyState==EventSource.CLOSED?console.log("連線關閉"):null!=e.readyState&&console.log(e.readyState)},!1)):console.log("瀏覽器不支援SSE!!")}function stopSSE(){null!=source&&(source.close(),console.log("關閉SSE"))}function startSwitch(){$("#msg_from_server").html("====================== [ Processing ] ======================<br>");var e=new Object;$.ajax({url:_ctx+"/plugin/module/vmswitch/go",data:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,beforeSend:function(e){showProcessing2(),startSSE()},complete:function(){},success:function(e){switchResult=e.message},error:function(e,o,s){ajaxErrorHandler()}})}function ajaxErrorHandler(){alert("連線逾時，頁面將重新導向"),location.reload()}$(document).ready(function(){$("#btnCheck").click(function(){checkVmStatus()}),$("#btnGo").click(function(){confirm('請再次確認是否要開始執行切換?<br><font color="red">** 切換過程無法暫停或中止 **</font>',"startSwitch")}),$("#btnClose").click(function(){$("#btnGo").attr("disabled",!0),hideProcessing2(),stopSSE(),window.location.replace(_ctx+"/plugin/module/vmswitch/result")}),stopSSE()});