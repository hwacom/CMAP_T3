var scriptShowLength=20,STEP_NUM=1;function showDeliveryPanelByBtnIpOpen(){window.sessionStorage.clear();var t=$(":radio:checked").val();$.ajax({url:_ctx+"/delivery/getScriptInfo.json",data:{scriptInfoId:t},type:"POST",dataType:"json",async:!0,success:function(e){"200"==e.code?(window.sessionStorage.setItem(_DELIVERY_SCRIPT_SYSTEM_VERSION_,e.data.systemVersion),window.sessionStorage.setItem(_DELIVERY_DEVICE_MENU_JSON_STR_,e.data.groupDeviceMenuJsonStr),window.sessionStorage.setItem(_DELIVERY_VAR_KEY_,e.data.actionScriptVariable),initStepPanel(3),STEP_NUM=3,initStepSection(),initStepBtn(),initStepImg(),initStepModalInput(),window.sessionStorage.setItem(_DELIVERY_SCRIPT_INFO_ID_,t),window.sessionStorage.setItem(_DELIVERY_SCRIPT_CODE_,e.data.scriptCode),window.sessionStorage.setItem(_DELIVERY_SCRIPT_NAME_,e.data.scriptName),$("#stepModal").modal({backdrop:"static"})):alert(e.message)},error:function(t,e,a){ajaxErrorHandler()}})}function showDeliveryPanel(){if(0!=$(":radio:checked").length){window.sessionStorage.clear();var t=$(":radio:checked").val();$.ajax({url:_ctx+"/delivery/getScriptInfo.json",data:{scriptInfoId:t},type:"POST",dataType:"json",async:!0,success:function(e){"200"==e.code?(window.sessionStorage.setItem(_DELIVERY_SCRIPT_SYSTEM_VERSION_,e.data.systemVersion),window.sessionStorage.setItem(_DELIVERY_DEVICE_MENU_JSON_STR_,e.data.groupDeviceMenuJsonStr),window.sessionStorage.setItem(_DELIVERY_VAR_KEY_,e.data.actionScriptVariable),initStepPanel(1),STEP_NUM=1,initStepSection(),initStepBtn(),initStepImg(),initStepModalInput(),window.sessionStorage.setItem(_DELIVERY_SCRIPT_INFO_ID_,t),window.sessionStorage.setItem(_DELIVERY_SCRIPT_CODE_,e.data.scriptCode),window.sessionStorage.setItem(_DELIVERY_SCRIPT_NAME_,e.data.scriptName),$("#stepModal").modal({backdrop:"static"})):alert(e.message)},error:function(t,e,a){ajaxErrorHandler()}})}else alert("請先選擇腳本!!")}function searchDevice(t){$.ajax({url:_ctx+"/base/getGroupDeviceMenu.json",data:{searchTxt:t,systemVersion:window.sessionStorage.getItem(_DELIVERY_SCRIPT_SYSTEM_VERSION_)},type:"POST",dataType:"json",async:!0,beforeSend:function(){},complete:function(){$("#stepModal_searchWaiting").hide()},success:function(t){if("200"==t.code){$("#stepModal_chooseDevice option").remove();var e="",a="",n=$.parseJSON(t.data.groupDeviceMenu);$.each(n,function(t,n){if(t.startsWith("GROUP"))e=t.split("_")[1],a=n,$("#stepModal_chooseDevice").append($("<option></option>").attr("class","multi-option-topic").attr("value","").attr("disabled","disabled").text(n));else{var o=t.replace("DEVICE_","");$("#stepModal_chooseDevice").append($("<option></option>").attr("class","multi-option-item").attr("value",o).attr("data-group-name",a).attr("data-group-id",e).text(n))}})}else alert(t.message)},error:function(t,e,a){ajaxErrorHandler()}})}function goStep(t){var e=parseInt(STEP_NUM)+parseInt(t),a=parseInt(STEP_NUM);if(parseInt(e)>parseInt(a)){if(!checkStepRequirement(a))return;initStepPanel(e)}$("#step"+e+"_section").show(),$("#step"+a+"_section").hide(),STEP_NUM=parseInt(STEP_NUM)+parseInt(t),initStepBtn(),initStepImg()}function checkStepRequirement(t){switch($(".required").removeClass("required"),t){case 1:return checkDeviceChoose();case 2:return checkVariable();case 3:return checkDeliveryParameters()}}function initStepPanel(t){switch(t){case 1:initStep1Panel();break;case 2:initStep2Panel();break;case 3:initStep3Panel()}}function initStep1Panel(){var t=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_VAR_KEY_)),e=window.sessionStorage.getItem(_DELIVERY_DEVICE_MENU_JSON_STR_);""===t?($("#stepModal_variable_description").text("此腳本不需輸入變數"),$("#stepModal_variable_description").removeClass("yellow bold")):($("#stepModal_variable_description").text("※ 此腳本需輸入變數值 : "),$("#stepModal_variable_description").addClass("yellow bold"),$("#stepModal_variable_show").text(t.join(", "))),$("#stepModal_chooseDevice option").remove();var a="",n="",o=$.parseJSON(e);$.each(o,function(t,e){if(t.startsWith("GROUP"))a=t.replace("GROUP_",""),n=e,$("#stepModal_chooseDevice").append($("<option></option>").attr("class","multi-option-topic").attr("value","").attr("data-group-id",a).attr("disabled","disabled").text(e));else{var o=t.replace("DEVICE_","");$("#stepModal_chooseDevice").append($("<option></option>").attr("class","multi-option-item").attr("value",o).attr("data-group-name",n).attr("data-group-id",a).text(e))}})}function initStep2Panel(){var t=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_GROUP_ID_)),e=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_DEVICE_ID_)),a=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_VAR_KEY_));$.ajax({url:_ctx+"/delivery/getVariableSetting.json",data:{groupArray:JSON.stringify(t),deviceArray:JSON.stringify(e),varKeyArray:JSON.stringify(a)},type:"POST",dataType:"json",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(t){"200"!=t.code&&alert(t.message),drawStep2Panel(t.data.info,t.data.symbol)},error:function(t,e,a){ajaxErrorHandler()}})}function drawStep2Panel(t,e){var a=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_GROUP_ID_)),n=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_DEVICE_ID_)),o=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_DEVICE_GROUP_NAME_)),r=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_DEVICE_NAME_)),i=$.parseJSON(window.sessionStorage.getItem(_DELIVERY_VAR_KEY_));if(0!=o.length){var s=o.length,l=null==i||null!=i&&0==i.length?1:i.length;$("#step2_target_table > thead").find("tr:gt(0)").remove();var d=$("<tr></tr>"),c=$("<tr></tr>");if(null!=i&&0!=i.length){l=0==i.length?1:i.length;var p=3;$.each(i,function(t,e){var a=$("<input>").attr("class","form-control form-control-sm fill-all-inpt").attr("name","fillAllInpt").attr("data-idx",p).attr("placeholder","(全部填入)");d.append($("<td></td>").attr("class","var-td").text(e)),c.append($("<td></td>").attr("class","var-td").append($(a).clone())),p++}),$("#step2_varKey_td").attr("colspan",l)}else d.append($("<td></td>").attr("class","var-td").attr("rowspan",2).text("不須輸入"));$("#step2_target_table > thead").append(d),null!=i&&0!=i.length&&($("#step2_target_table > thead").append(c),$(":input[name=fillAllInpt]").on("keyup",function(t){var e=t.target;fillAllRow($(e).data("idx"),$(e).val())})),$("#step2_target_table > tbody").empty();for(var _=0;_<s;_++){var u=parseInt(_)+1,g=_<o.length?o[_]:"N/A",S=_<r.length?r[_]:"N/A",E=(_<a.length?a[_]:0)+e+(_<n.length?n[_]:0),I=$("<tr></tr>").append([$("<td></td>").attr("class","center").attr("width","5%").text(u)],[$("<td></td>").attr("width","10%").text(g)],[$("<td></td>").attr("width","20%").text(S)]);if(null!=i&&0!=i.length){var h=$("<td></td>").append($("<input>").attr("type","text").attr("class","form-control form-control-sm").attr("name","input_var").attr("data-idx",_));$.each(i,function(e,a){if(isEmpty(t))I.append($(h).clone());else{var n=t[E];if(null!=n){var o=n[a];if(null!=o&&o.length>0){var r=$("<td></td>"),i=$("<select></select>").attr("class","form-control form-control-sm").attr("name","input_var").attr("data-idx",_);$.each(o,function(t,e){var a=$("<option></option>").attr("value",e.infoValue).text(e.infoValue);i.append(a)}),r.append(i),I.append(r)}else I.append($(h).clone())}}})}$("#step2_target_table > tbody").append(I)}$(":input[name=input_var]").on("change",function(t){var e=t.target;""!=$(e).val()&&$(e).hasClass("required")&&$(e).removeClass("required")}),$("#step2_target_table > tbody").animate({scrollTop:0},500,"easeOutBounce")}}function initStep3Panel(){$("#stepModal_preview").empty();var t=window.sessionStorage.getItem(_DELIVERY_SCRIPT_NAME_),e=window.sessionStorage.getItem(_DELIVERY_DEVICE_GROUP_NAME_),a=window.sessionStorage.getItem(_DELIVERY_DEVICE_NAME_),n=window.sessionStorage.getItem(_DELIVERY_VAR_KEY_),o=window.sessionStorage.getItem(_DELIVERY_VAR_VALUE_),r=$.parseJSON(n),i=r.length,s=$("<span></span>").attr("class","preview-topic"),l=$("<br>"),d=$("<hr>").attr("class","bg_yellow"),c=$("<table></table>").attr("id","step3_target_table").attr("class","mySTable center"),p=$("<thead></thead>").attr("class","bold").append($("<tr></tr>").append($("<td></td>").attr("rowspan",2).attr("width","5%").text("序")).append($("<td></td>").attr("rowspan",2).attr("width","15%").text("群組名稱")).append($("<td></td>").attr("rowspan",2).attr("width","20%").text("設備名稱")).append($("<td></td>").attr("colspan",i).attr("width","60%").text("變數值"))),_=$("<tr></tr>");$.each(r,function(t,e){_.append($("<td></td>").attr("class","var-td").text(e))}),p.append(_);var u=$("<tbody></tbody>");c.append(p).append(u);for(var g=$.parseJSON(e),S=$.parseJSON(a),E=$.parseJSON(o),I=0;I<g.length;I++){var h=$("<tr></tr>").append([$("<td></td>").attr("width","5%").text(I+1)],[$("<td></td>").attr("width","15%").text(g[I])],[$("<td></td>").attr("width","20%").text(S[I])]),m=E[I];$.each(m,function(t,e){h.append($("<td></td>").text(e)),c.append(h)})}$("#stepModal_preview").append([s.clone().text("腳本名稱 : ").attr("class","bold")],[$("<span></span>").text(" "+t).attr("class","yellow bold")],[l.clone()],[d.clone()],[s.clone().text("派送對象與變數值 : ").attr("class","bold")],[l.clone()],[c])}function fillAllRow(t,e){var a=$("#step2_target_table").find("tr:gt(2)").find("td:eq("+t+")").find(":input");$.each(a,function(t,a){$(a).val(e),$(a).trigger("change")})}function checkDeviceChoose(){var t=$("#stepModal_chooseDevice option:selected");if(0==t.length)return alert("請選擇設備"),$("#stepModal_chooseDevice").addClass("required"),!1;var e=[],a=[],n=[],o=[];return $.each(t,function(t,r){e.push($(r).val()),a.push($(r).text()),n.push($(r).data("group-id")+""),o.push($(r).data("group-name"))}),console.log(window.sessionStorage.getItem(_DELIVERY_DEVICE_ID_)),console.log(window.sessionStorage.getItem(_DELIVERY_GROUP_ID_)),window.sessionStorage.setItem(_DELIVERY_DEVICE_ID_,JSON.stringify(e)),window.sessionStorage.setItem(_DELIVERY_DEVICE_NAME_,JSON.stringify(a)),window.sessionStorage.setItem(_DELIVERY_GROUP_ID_,JSON.stringify(n)),window.sessionStorage.setItem(_DELIVERY_DEVICE_GROUP_NAME_,JSON.stringify(o)),window.sessionStorage.setItem(_DELIVERY_REASON_,$("#stepModal_reason").val()),!0}function checkVariable(){$.parseJSON(window.sessionStorage.getItem(_DELIVERY_VAR_KEY_));var t=$("input[name=input_var]"),e=$("select[name=input_var]"),a=!0,n=[],o=[];return t.length>0&&$.each(t,function(t,e){if(0==e.value.trim().length)a=!1,n.push(e);else{var r=$(e).data("idx");void 0===o[r]&&(o[r]=[]),o[r].push(e.value)}}),e.length>0&&$.each(e,function(t,e){if(0==e.value.trim().length)a=!1,n.push(e);else{var r=$(e).data("idx");void 0===o[r]&&(o[r]=[]),o[r].push(e.value)}}),a?(window.sessionStorage.setItem(_DELIVERY_VAR_VALUE_,JSON.stringify(o)),a):($.each(n,function(t,e){$(e).addClass("required")}),alert("請輸入變數值"),!1)}function checkDeliveryParameters(){var t=window.sessionStorage.getItem(_DELIVERY_SCRIPT_INFO_ID_),e=window.sessionStorage.getItem(_DELIVERY_SCRIPT_CODE_),a=window.sessionStorage.getItem(_DELIVERY_DEVICE_ID_),n=window.sessionStorage.getItem(_DELIVERY_VAR_KEY_),o=window.sessionStorage.getItem(_DELIVERY_VAR_VALUE_);if(null==t||null!=t&&0==t.trim().length||null==e||null!=e&&0==e.trim().length||null==a||null!=a&&0==a.trim().length||null==n||null!=n&&0==n.trim().length||null==o||null!=o&&0==o.trim().length)return alert("派送所需參數內容檢核有異常，系統將自動重整畫面，並請再重新操作；若此異常訊息仍再次出現，請通知系統維護人員，謝謝"),location.reload(),!1}function doDelivery(){alert("供裝派送成功"),setTimeout(function(){$("#stepModal").modal("hide")},500)}function initStepImg(){var t=parseInt(STEP_NUM)-1;$(".step-img").removeClass("step-current"),$(".step-img").eq(t).addClass("step-current")}function initStepSection(){$("#step1_section").show(),$("#step2_section").hide(),$("#step3_section").hide()}function initStepModalInput(){$("#stepModal_searchDevice").val(""),$("#stepModal_reason").val("")}function initStepBtn(){switch(STEP_NUM){case 1:$("#btnStepGoPrev").hide(),$("#btnStepGoNext").show(),$("#btnStepGoFire").hide();break;case 2:$("#btnStepGoPrev").show(),$("#btnStepGoNext").show(),$("#btnStepGoFire").hide();break;case 3:$("#btnStepGoPrev").show(),$("#btnStepGoNext").hide(),$("#btnStepGoFire").show()}}function showFullScript(t){var e=t.parent().find("td").eq(2).text(),a=t.attr("content");$("#viewScriptModal_scriptName").text(e);a=null!=a?a.replace(/(\r\n|\r|\n)/g,"<br>"):"異常無紀錄";$("#viewScriptModal_scriptContent").html(a),$("#viewScriptModal").modal("show")}function findData(t){$("#queryFrom").val(t),"undefined"!=typeof resultTable?resultTable.ajax.reload():($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!0,bFilter:!0,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(t,e,a){null!=e.actionScript&&e.actionScript.length>scriptShowLength&&($(t).children("td").eq(5).attr("onclick","javascript:showFullScript($(this));"),$(t).children("td").eq(5).addClass("cursor_zoom_in")),$(t).children("td").eq(5).attr("content",e.actionScript)},ajax:{url:_ctx+"/delivery/getScriptListData.json",type:"POST",data:function(t){return"WEB"==$("#queryFrom").val()?t.queryScriptTypeCode=$("#queryScriptTypeCode").val():"MOBILE"==$("#queryFrom").val()&&(t.queryScriptTypeCode=$("#queryScriptTypeCode_mobile").val()),t.onlyOneScript=$("#onlyOneScript").val(),t},error:function(t,e,a){ajaxErrorHandler()}},order:[[2,"asc"]],pageLength:10,drawCallback:function(t){$("div.dataTables_length").parent().removeClass("col-sm-12"),$("div.dataTables_length").parent().addClass("col-sm-6"),$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),$("div.dataTables_paginate").parent().removeClass("col-sm-12"),$("div.dataTables_paginate").parent().addClass("col-sm-6"),bindTrEvent(),initCheckedItems(),"function"==typeof findBlockedIpRecordData?(findBlockedIpRecordData(),bindTrEventOnlyRadio()):bindTrEvent()},columns:[{},{},{data:"scriptName"},{data:"scriptTypeName"},{data:"systemVersion",className:"center"},{},{data:"actionScriptRemark",orderable:!1}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(t,e,a){return'<input type="radio" id="radioBox" name="radioBox" onclick="changeTrBgColor(this)" value='+a.scriptInfoId+">"}},{targets:[1],className:"center",searchable:!1,orderable:!1,render:function(t,e,a,n){return n.row+n.settings._iDisplayStart+1}},{targets:[5],className:"left",searchable:!0,orderable:!1,render:function(t,e,a,n){return null!=a.actionScript&&a.actionScript.length>scriptShowLength?getPartialContentHtml(a.actionScript,scriptShowLength):a.actionScript}}]}))}$(document).ready(function(){var t=$("#onlyOneScript").val();"SWITCH_PORT"==t?(initMenuStatus("toggleMenu_plugin","toggleMenu_plugin_items","cm_switchPort"),findData("WEB")):"IP_OPEN_BLOCK"==t?(initMenuStatus("toggleMenu_plugin","toggleMenu_plugin_items","cm_ipOpenBlock"),findData("WEB")):"MAC_OPEN_BLOCK"==t?(initMenuStatus("toggleMenu_plugin","toggleMenu_plugin_items","cm_macOpenBlock"),findData("WEB")):initMenuStatus("toggleMenu_cm","toggleMenu_cm_items","cm_delivery"),$("#viewScriptModal").on("shown.bs.modal",function(){setTimeout(function(){$("#viewScriptModal_scriptContent").scrollTop(0)},30)}),$("#btnDelivery").click(function(t){showDeliveryPanel()}),$("#btnStepGoPrev").click(function(t){goStep(-1)}),$("#btnStepGoNext").click(function(t){t.preventDefault(),goStep(1)}),$("#btnStepGoFire").click(function(t){doDelivery()}),$("#stepModal_searchDevice").keydown(function(t){$("#stepModal_searchWaiting").show()}),$("#stepModal_searchDevice").keyup(_.debounce(function(t){searchDevice($(this).val())},500)),findData("WEB")});